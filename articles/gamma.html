<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manual • gamma</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Manual">
<meta property="og:description" content="">
<meta property="og:image" content="https://crp2a.github.io/gamma/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gamma</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/gamma.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cerege_1.html">CEREGE Calibration Curve #1</a>
    </li>
    <li>
      <a href="../articles/crp2a_1.html">CRP2A Calibration Curve #1</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/crp2a/gamma">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Manual</h1>
                        <h4 class="author">N. Frerebeau</h4>
            
            <h4 class="date">2019-11-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/crp2a/gamma/blob/master/vignettes/gamma.Rmd"><code>vignettes/gamma.Rmd</code></a></small>
      <div class="hidden name"><code>gamma.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(gamma)</a></code></pre></div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p><strong>gamma</strong> is intended to process in-situ gamma-ray spectrometry measurements for luminescence dating. This package allows to import, inspect and (automatically) correct the energy scale of the spectrum. It provides methods for estimating the gamma dose rate by the use of a calibration curve. This package only supports Canberra CNF and TKA files.</p>
<p>Typical workflow:</p>
<ol style="list-style-type: decimal">
<li>Import spectrum data with <code><a href="../reference/read.html">read()</a></code>,</li>
<li>Inspect spectrum with <code><a href="../reference/plot.html">plot()</a></code>,</li>
<li>Calibrate the energy scale with <code><a href="../reference/energy.html">calibrate_energy()</a></code>,</li>
<li>Estimate the gamma dose rate with <code><a href="../reference/doserate.html">predict_dose()</a></code>.</li>
</ol>
<p>The estimation of the gamma dose rate requires a calibration curve. This package contains several built-in curves, but as these are instrument-specific you may need to build your own (see <code><a href="https://rdrr.io/r/utils/help.html">help(fit)</a></code>). These built-in curves are in use in several labs and can be used to reproduce published results. Check out the following vignettes for an overview of the fitting process.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># IRAMAT-CRP2A LaBr (BDX1)</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">utils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span>(<span class="st">"CRP2A#1"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># CEREGE NaI (AIX1)</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">utils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span>(<span class="st">"CEREGE#1"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a></code></pre></div>
<p>Note that <strong>gamma</strong> uses the <em>International System of Units</em>: energy values are assumed to be in keV and dose rates in µGy/y.</p>
</div>
<div id="import-file" class="section level1">
<h1 class="hasAnchor">
<a href="#import-file" class="anchor"></a>Import file</h1>
<p>Both Canberra CNF and TKA files can be imported.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Automatically skip the first chanels</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># Import a CNF file</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">cnf_test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/test_CNF.cnf"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">(spc_cnf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(cnf_test))</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; Gamma spectrum:</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; *  name: test_CNF</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; *  date: 2019-02-07 11:48:18</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; *  live time: 3385.54</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; *  real time: 3403.67</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; *  chanels: 1024</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; *  energy range: -7 3124.91</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co"># Import a TKA file</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">tka_test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/test_TKA.tka"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">(spc_tka &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(tka_test))</a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; Gamma spectrum:</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; *  name: test_TKA</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; *  date: 2019-11-07 18:22:04</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; *  live time: 3385.54</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt; *  real time: 3403.67</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#&gt; *  chanels: 1024</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt; *  energy range: not calibrated</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co"># Import all files in a given directory</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">files_test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">(spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(files_test))</a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt; A collection of 2 gamma spectra: test_CNF, test_TKA</span></a></code></pre></div>
</div>
<div id="inspect-spectrum" class="section level1">
<h1 class="hasAnchor">
<a href="#inspect-spectrum" class="anchor"></a>Inspect spectrum</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Plot CNF spectrum</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="../reference/plot.html">plot</a></span>(spc_cnf) <span class="op">+</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/inspect-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="calibrate-the-energy-scale" class="section level1">
<h1 class="hasAnchor">
<a href="#calibrate-the-energy-scale" class="anchor"></a>Calibrate the energy scale</h1>
<p>The energy calibration of a spectrum is the most tricky part. To do this, you must specify the position of at least three observed peaks and the corresponding energy value (in keV).</p>
<p>The package allows you to provide the channel-energy pairs you want to use. However, the spectrum can be noisy so it is difficult to properly determine the peak channel. In this case, a better approach may be to pre-process the spectrum (variance-stabilization, smoothing and baseline correction) and perform a peak detection. Once the identified peaks are satisfactory, you can set the corresponding energy values (in keV) and use these lines to calibrate the energy scale of the spectrum.</p>
<p>Regardless of the approach you choose, it is strongly recommended to check the result before proceeding.</p>
<div id="workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#workflow" class="anchor"></a>Workflow</h2>
<p>The following steps illustrate how to properly fine-tune the parameters for spectrum processing before peak detection.</p>
<div id="clean" class="section level3">
<h3 class="hasAnchor">
<a href="#clean" class="anchor"></a>Clean</h3>
<p>Several channels can be dropped to retain only part of the spectrum. If no specific value is provided, an attempt is made to define the number of channels to skip at the beginning of the spectrum. This drops all channels before the highest count maximum. This is intended to deal with the artefact produced by the rapid growth of random background noise towards low energies.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Use a square root transformation</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">sliced &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slice.html">slice_signal</a></span>(spc_tka)</a></code></pre></div>
</div>
<div id="stabilization" class="section level3">
<h3 class="hasAnchor">
<a href="#stabilization" class="anchor"></a>Stabilization</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Use a square root transformation</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">transformed &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stabilize.html">stabilize_signal</a></span>(sliced, <span class="dt">transformation =</span> sqrt)</a></code></pre></div>
</div>
<div id="smoothing" class="section level3">
<h3 class="hasAnchor">
<a href="#smoothing" class="anchor"></a>Smoothing</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># Use a 21 point Savitzky-Golay-Filter to smooth the spectrum</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">smoothed &lt;-<span class="st"> </span><span class="kw"><a href="../reference/smooth.html">smooth_signal</a></span>(transformed, <span class="dt">method =</span> <span class="st">"savitzky"</span>, <span class="dt">m =</span> <span class="dv">21</span>)</a></code></pre></div>
</div>
<div id="baseline-correction" class="section level3">
<h3 class="hasAnchor">
<a href="#baseline-correction" class="anchor"></a>Baseline correction</h3>
<p>The baseline estimation is performed using the SNIP algorithm <span class="citation">(Ryan et al. 1988; Morháč et al. 1997; Morháč and Matoušek 2008)</span>. You can apply the LLS operator to your data, use a decreasing clipping window or change the number of iterations (see references).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># Estimate the baseline of a single file</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">baseline &lt;-<span class="st"> </span><span class="kw"><a href="../reference/baseline.html">estimate_baseline</a></span>(smoothed, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co"># Plot spectrum + baseline</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="kw"><a href="../reference/plot.html">plot</a></span>(smoothed, baseline) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">title =</span> <span class="st">"Spectrum + baseline"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/baseline-estimate-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># Substract the estimated baseline</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">corrected &lt;-<span class="st"> </span>smoothed <span class="op">-</span><span class="st"> </span>baseline</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># Or, remove the baseline in one go</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># corrected &lt;- removeBaseline(smoothed)</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># Plot the corrected spectrum</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw"><a href="../reference/plot.html">plot</a></span>(corrected) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">title =</span> <span class="st">"Baseline-corrected spectrum"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/baseline-remove-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># You can remove the baseline of multiple spectra in one go</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># Note that the same parameters will be used for all spectra</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">clean &lt;-<span class="st"> </span><span class="kw"><a href="../reference/baseline.html">remove_baseline</a></span>(spc)</a></code></pre></div>
</div>
<div id="peak-detection" class="section level3">
<h3 class="hasAnchor">
<a href="#peak-detection" class="anchor"></a>Peak detection</h3>
<p>Once you have a baseline-corrected spectrum, you can try to automatically find peaks in the spectrum. A local maximum has to be the highest one in the given window and has to be higher than <span class="math inline">\(k\)</span> times the noise to be recognized as peak.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># Detect peaks in a single file</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">peaks &lt;-<span class="st"> </span><span class="kw"><a href="../reference/peaks.html">find_peaks</a></span>(corrected)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># Plot spectrum + peaks</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw"><a href="../reference/plot.html">plot</a></span>(corrected, peaks) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">title =</span> <span class="st">"Peaks"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/peak-detection-1.png" width="700"></p>
</div>
<div id="energy-scale-calibration" class="section level3">
<h3 class="hasAnchor">
<a href="#energy-scale-calibration" class="anchor"></a>Energy scale calibration</h3>
<p>If you know the correspondence between several channels and the energy scale, you can use these pairs of values to calibrate the spectrum. A second order polynomial model is fitted on these energy <em>vs</em> chanel values, then used to predict the new energy scale of the spectrum.</p>
<p>You can use the results of the peak detection and set the expected energy values.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Set the energy values (in keV)</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw">set_energy</span>(peaks) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">238</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="dv">1461</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="dv">2615</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">peaks</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt; 8 peaks were detected:</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt;   chanel energy</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; 1     86    238</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; 2    208     NA</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co">#&gt; 3    316     NA</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt; 4    384     NA</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt; 5    496   1461</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt; 6    596     NA</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt; 7    722     NA</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt; 8    879   2615</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co"># Calibrate the spectrum using the peak positions</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16">scaled &lt;-<span class="st"> </span><span class="kw"><a href="../reference/energy.html">calibrate_energy</a></span>(spc_tka, peaks)</a>
<a class="sourceLine" id="cb12-17" data-line-number="17"></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co"># Plot the spectrum</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="kw"><a href="../reference/plot.html">plot</a></span>(scaled, <span class="dt">xaxis =</span> <span class="st">"energy"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">title =</span> <span class="st">"Calibrated spectrum"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/calibrate-fit-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Alternatively, you can do it by hand.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Create a list of chanel-enegy pairs</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">calib_lines &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="dt">chanel =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">84</span>, <span class="dv">492</span>, <span class="dv">865</span>),</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  <span class="dt">energy =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">238</span>, <span class="dv">1461</span>, <span class="dv">2615</span>)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co"># Calibrate the spectrum using these fixed lines</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">scaled2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/energy.html">calibrate_energy</a></span>(spc_tka, <span class="dt">lines =</span> calib_lines)</a></code></pre></div>
</div>
</div>
<div id="use-the-pipe" class="section level2">
<h2 class="hasAnchor">
<a href="#use-the-pipe" class="anchor"></a>Use the pipe!</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co"># Spectrum pre-processing and peak detection</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">pks &lt;-<span class="st"> </span>spc_tka <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/slice.html">slice_signal</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="../reference/stabilize.html">stabilize_signal</a></span>(<span class="dt">transformation =</span> sqrt) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="../reference/smooth.html">smooth_signal</a></span>(<span class="dt">method =</span> <span class="st">"savitzky"</span>, <span class="dt">m =</span> <span class="dv">21</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="../reference/baseline.html">remove_baseline</a></span>(<span class="dt">decreasing =</span> <span class="ot">TRUE</span>, <span class="dt">k =</span> <span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="../reference/peaks.html">find_peaks</a></span>()</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="co"># Set the energy values (in keV)</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="kw">set_energy</span>(pks) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">238</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="dv">1461</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="dv">2615</span>)</a>
<a class="sourceLine" id="cb14-13" data-line-number="13"></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="co"># Calibrate the energy scale</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">cal &lt;-<span class="st"> </span><span class="kw"><a href="../reference/energy.html">calibrate_energy</a></span>(spc_tka, pks)</a>
<a class="sourceLine" id="cb14-16" data-line-number="16"></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="co"># Plot spectrum</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="kw"><a href="../reference/plot.html">plot</a></span>(cal, pks) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/pipe-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="estimate-the-gamma-dose-rate" class="section level1">
<h1 class="hasAnchor">
<a href="#estimate-the-gamma-dose-rate" class="anchor"></a>Estimate the gamma dose rate</h1>
<p>To estimate the gamma dose rate, you can either use one of the calibration curves distributed with this package or build your own.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># Load one of the built-in curves</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(BDX100) <span class="co"># IRAMAT-CRP2A (Bordeaux)</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(AIX100) <span class="co"># CEREGE (Aix-en-Provence)</span></a></code></pre></div>
<p>The construction of a calibration curve requires a set of reference spectra for which the gamma dose rate is known and a background noise measurement. First, each reference spectrum is integrated over a given interval, then normalized to active time and corrected for background noise. The dose rate is finally modelled by the integrated signal value used as a linear predictor.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># Import the reference spectra</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">calib_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/BDX100/calibration"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">calib_spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(calib_dir)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co"># Import the spectra for background noise measurement</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">noise_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/BDX100/background"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">noise_spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(noise_dir)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co"># Set the known dose rates</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"clermont"</span>)</a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="kw">set_dose</span>(calib_spc) &lt;-<span class="st"> </span>clermont[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"gamma"</span>, <span class="st">"gamma_error"</span>)]</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="co"># Build the calibration curve</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14">calib_curve &lt;-<span class="st"> </span><span class="kw"><a href="../reference/doserate.html">fit_dose</a></span>(</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">  calib_spc,</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">  noise_spc,</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">  <span class="dt">range =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">165</span>, <span class="dv">2800</span>), <span class="co"># Set the integration range (in keV)</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18">  <span class="dt">intercept =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb16-20" data-line-number="20"></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"><span class="co"># The linear model can be accessed for further investigations</span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="co"># summary(calib_curve[["model"]])</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23"></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="co"># Plot the calibration curve</span></a>
<a class="sourceLine" id="cb16-25" data-line-number="25"><span class="kw"><a href="../reference/plot.html">plot</a></span>(calib_curve) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/dose-rate-calib-1.png" width="480" style="display: block; margin: auto;"></p>
<p>New dose rate values can be predicted.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># Import spectra</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">test_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/BDX100/test"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">test_spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(test_dir)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co"># Estimate the gamma dose rate</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">dose_rate &lt;-<span class="st"> </span><span class="kw"><a href="../reference/doserate.html">predict_dose</a></span>(calib_curve, test_spc, <span class="dt">simplify =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<table class="table">
<caption>Gamma dose rate estimates</caption>
<thead><tr class="header">
<th></th>
<th align="left">name</th>
<th align="right">signal_value</th>
<th align="right">signal_error</th>
<th align="right">dose_value</th>
<th align="right">dose_error</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>BR2011-08</td>
<td align="left">BR2011-08</td>
<td align="right">11308.46</td>
<td align="right">10.79</td>
<td align="right">313.56</td>
<td align="right">5.94</td>
</tr>
<tr class="even">
<td>BR2011-15A</td>
<td align="left">BR2011-15A</td>
<td align="right">7593.46</td>
<td align="right">12.26</td>
<td align="right">195.20</td>
<td align="right">3.70</td>
</tr>
<tr class="odd">
<td>BR2011-15B</td>
<td align="left">BR2011-15B</td>
<td align="right">7544.27</td>
<td align="right">9.79</td>
<td align="right">193.64</td>
<td align="right">3.67</td>
</tr>
<tr class="even">
<td>BR2011-16</td>
<td align="left">BR2011-16</td>
<td align="right">5909.53</td>
<td align="right">9.39</td>
<td align="right">141.56</td>
<td align="right">2.69</td>
</tr>
<tr class="odd">
<td>BR2011-20</td>
<td align="left">BR2011-20</td>
<td align="right">44099.22</td>
<td align="right">18.66</td>
<td align="right">1358.22</td>
<td align="right">25.69</td>
</tr>
<tr class="even">
<td>BR2011-23</td>
<td align="left">BR2011-23</td>
<td align="right">13818.07</td>
<td align="right">8.43</td>
<td align="right">393.51</td>
<td align="right">7.45</td>
</tr>
<tr class="odd">
<td>BR2011-24</td>
<td align="left">BR2011-24</td>
<td align="right">12426.02</td>
<td align="right">10.95</td>
<td align="right">349.16</td>
<td align="right">6.61</td>
</tr>
<tr class="even">
<td>BR2011-26</td>
<td align="left">BR2011-26</td>
<td align="right">12091.73</td>
<td align="right">9.29</td>
<td align="right">338.51</td>
<td align="right">6.41</td>
</tr>
<tr class="odd">
<td>BR2011-27</td>
<td align="left">BR2011-27</td>
<td align="right">10029.99</td>
<td align="right">11.37</td>
<td align="right">272.83</td>
<td align="right">5.17</td>
</tr>
<tr class="even">
<td>BR2011-29</td>
<td align="left">BR2011-29</td>
<td align="right">8854.52</td>
<td align="right">7.58</td>
<td align="right">235.38</td>
<td align="right">4.46</td>
</tr>
<tr class="odd">
<td>SC2019</td>
<td align="left">SC2019</td>
<td align="right">3401.60</td>
<td align="right">9.03</td>
<td align="right">61.66</td>
<td align="right">1.18</td>
</tr>
</tbody>
</table>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-morhac1997">
<p>Morháč, Miroslav, Ján Kliman, Vladislav Matoušek, Martin Veselský, and Ivan Turzo. 1997. “Background Elimination Methods for Multidimensional Coincidence <span class="math inline">\(\gamma\)</span>-Ray Spectra.” <em>Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment</em> 401 (1): 113–32. <a href="https://doi.org/10.1016/S0168-9002(97)01023-1" class="uri">https://doi.org/10.1016/S0168-9002(97)01023-1</a>.</p>
</div>
<div id="ref-morhac2008">
<p>Morháč, Miroslav, and Vladislav Matoušek. 2008. “Peak Clipping Algorithms for Background Estimation in Spectroscopic Data.” <em>Applied Spectroscopy</em> 62 (1): 91–106. <a href="https://doi.org/10.1366/000370208783412762" class="uri">https://doi.org/10.1366/000370208783412762</a>.</p>
</div>
<div id="ref-ryan1988">
<p>Ryan, C.G., E. Clayton, W.L. Griffin, S.H. Sie, and D.R. Cousens. 1988. “SNIP, a Statistics-Sensitive Background Treatment for the Quantitative Analysis of PIXE Spectra in Geoscience Applications.” <em>Nuclear Instruments and Methods in Physics Research Section B: Beam Interactions with Materials and Atoms</em> 34 (3): 396–402. <a href="https://doi.org/10.1016/0168-583X(88)90063-8" class="uri">https://doi.org/10.1016/0168-583X(88)90063-8</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#import-file">Import file</a></li>
      <li><a href="#inspect-spectrum">Inspect spectrum</a></li>
      <li>
<a href="#calibrate-the-energy-scale">Calibrate the energy scale</a><ul class="nav nav-pills nav-stacked">
<li><a href="#workflow">Workflow</a></li>
      <li><a href="#use-the-pipe">Use the pipe!</a></li>
      </ul>
</li>
      <li><a href="#estimate-the-gamma-dose-rate">Estimate the gamma dose rate</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nicolas Frerebeau, Brice Lebrun, Guilhem Paradol, <a href="https://www.u-bordeaux-montaigne.fr"><img src="https://crp2a.github.io/gamma/reference/figures/logo_ubm.jpg" height="48"></a>, <a href="https://lascarbx.labex.u-bordeaux.fr"><img src="https://crp2a.github.io/gamma/reference/figures/logo_lascarbx.jpg" height="64"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
